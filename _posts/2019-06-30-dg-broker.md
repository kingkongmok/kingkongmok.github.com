---
layout: post
title: "oracle dg broker"
category: oracle
tags: [oracle, dg, broker, dgmgrl, switchover ]
---


## 配置dg broker



#### primary名称：

```
SYS@orsid1> show parameter name

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
cell_offloadgroup_name               string
db_file_name_convert                 string      +DATA, +DATA
db_name                              string      oradb
db_unique_name                       string      oradb
global_names                         boolean     FALSE
instance_name                        string      orsid1
lock_name_space                      string
log_file_name_convert                string      +DATA, +DATA, +ARCH, +ARCH
processor_group_name                 string
service_names                        string      oradb
```

broker配置需放置shared storage中，以便RAC能顺利读取配置。


```
SYS@orsid1> alter system set dg_broker_config_file1='+DATA/oradb/datafile/dr1oradb.dat'  scope=both sid='*';
SYS@orsid1> alter system set dg_broker_config_file2='+DATA/oradb/datafile/dr2oradb.dat'  scope=both sid='*';
```

#### 运行dg broker：

```
SYS@orsid1> alter system set dg_broker_start=TRUE scope=both sid='*';
```

#### 添加listener

注意 **GLOBAL_DBNAME** 为 **<DB_UNIQUE_NAME>_DGMGRL.<DB_DOMAIN>**

```
SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
     (ORACLE_HOME = /u01/app/oracle/product/11.2.0/db_1 )
     (SID_NAME = orsid1 )
     (GLOBAL_DBNAME=oradb )
    )
    (SID_DESC =
      (GLOBAL_DBNAME = oradb_DGMGRL)
      (ORACLE_HOME = /u01/app/oracle/product/11.2.0/db_1)
      (SID_NAME = orsid1)
      (SERVICE_NAME = oradb)
    )
)
```

---

#### standby名称：

```

SQL> show parameter name

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
cell_offloadgroup_name               string
db_file_name_convert                 string      +DATA, /u01/app/oracle/oradata
db_name                              string      oradb
db_unique_name                       string      ADG
global_names                         boolean     FALSE
instance_name                        string      ADG
lock_name_space                      string
log_file_name_convert                string      +DATA, /u01/app/oracle/oradata
                                                 , +ARCH, /u01/app/oracle/flash
                                                 _recovery_area
processor_group_name                 string
service_names                        string      ADG

```

#### 运行dg broker：

或许可以省略指定broker配置文件路径 dg_broker_config_file1，待测试，。


```
SYS@ADG> alter system set dg_broker_start=TRUE scope=both sid='*';
```

#### 添加standby的listener:

```

SID_LIST_LISTENER =
  (SID_LIST =
    (SID_DESC =
     (ORACLE_HOME = /u01/app/oracle/product/11.2.0/dbhome_1)
     (SID_NAME = ADG)
     (GLOBAL_DBNAME=ADG)
    )
    (SID_DESC =
     (ORACLE_HOME = /u01/app/oracle/product/11.2.0/dbhome_1)
     (SID_NAME = ADG)
     (GLOBAL_DBNAME=ADG_DGMGRL )
     (SERVICE_NAME=ADG )
    )
 )
 
```

---

## dgmgrl 配置

在primary进行dg broker设置，不需在standby中设置。

```
DGMGRL> connect sys/oracle
DGMGRL> CREATE CONFIGURATION 'oradb_config' as PRIMARY DATABASE IS 'oradb' connect identifier is 'oradb' ;
DGMGRL> add database 'ADG' AS CONNECT IDENTIFIER IS 'ADG' MAINTAINED AS PHYSICAL;   
DGMGRL> enable configuration
Enabled.
DGMGRL> show configuration

Configuration - oradb_config

  Protection Mode: MaxPerformance
  Databases:
    oradb - Primary database
    ADG   - Physical standby database

Fast-Start Failover: DISABLED

Configuration Status:
SUCCESS

```

---

### 故障排错

刚刚开始的时候出现异常，后来通过删除DGMGRL的配置，重新配置后正常：
有配置，确实单引号导致异常，Physical standby disable ，解决办法是将config删除重新添加

DGMGRL> remove database 'ADG';
Removed database "ADG" from the configuration

DGMGRL> add database 'ADG' AS CONNECT IDENTIFIER IS 'ADG' MAINTAINED AS PHYSICAL;                   
Database "ADG" added
DGMGRL> show configuration

Configuration - oradb_config

  Protection Mode: MaxPerformance
  Databases:
    oradb - Primary database
    ADG   - Physical standby database (disabled)

Fast-Start Failover: DISABLED

Configuration Status:
SUCCESS

