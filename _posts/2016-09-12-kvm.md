---
title: "kvm"
layout: post
category: linux
---

### install

```
sudo apt-get install qemu-kvm libvirt-bin ubuntu-vm-builder bridge-utils
```

---

### create vm

```
#!/bin/sh
vm_name=$1
vm_img="/var/kvm/vm/${vm_name}.qcow2"
qemu-img create -f qcow2 $vm_img 8G
virt-install \
     --name $vm_name \
     --ram 512 \
     --disk path=$vm_img,format=qcow2 \
     --accelerate \
     --network network=default,model=virtio \
     --cdrom /var/kvm/iso/ubuntu-14.04.3-server-amd64.iso \
     --boot cdrom \
     --vnc 
```

---

### [Kvm虚拟机部署方案](http://xstarcd.github.io/wiki/Cloud/ubuntu_kvm_virtualization_solution.html)

涉及的几个概念：

+ Domain：
虚拟机的一个运行实例，简单的理解，就是一个虚拟机虚拟出来的操作系统。它的叫法可是多种多样：instance，guest OS，virsual machine，其实都指的同一个概念。
+ Hypervisor：
指的就是虚拟机本身，比如qemu, kvm, xen...
+ libvirt
由几个不同的部分组成，其中包括应用程序编程接口 (API) 库、一个守护进程 (libvirtd)，以及一个默认命令行实用工具 (virsh)，libvirtd守护进程负责对虚拟机的管理工作，在用各种工具对虚拟机进行管理的时候，这个守护进程一定要跑起来，而且这个进程可以分为两种，一种是root权限的libvirtd，一种是普通用户权限的libvirtd，前者权限大，可以虚拟计算机的各种设备。
+ 开启root权限的libvirtd守护进程要以root身份去运行：sudo libvirtd --daemon


---

## [gentoo](http://big-elephants.com/2013-07/creating-virtual-networks-with-kvm-on-gentoo/)

#### Using virt-manager

常用的命令，例如**virt-install**都是需要virt-manager提供的，需要安装

---


### virt-network

如果**app-emulation/libvirt** 没有 **virt-network** 会出现异常如下：

```
this function is not supported by the connection driver: virConnectNumOfNetworks
```

---

```
echo ">=app-emulation/libvirt-1.0.3-r2 virt-network qemu" >> /etc/portage/package.use
```


libvirt需要使用virt-network支持，但不需要**net-misc/bridge-utils**，猜错了。

```
$ equery g app-emulation/libvirt
 * dependency graph for app-emulation/libvirt-2.3.0
 `--  app-emulation/libvirt-2.3.0  [~amd64 keyword] 
   `--  app-misc/scrub-2.5.2  (app-misc/scrub) amd64 
   `--  dev-libs/libgcrypt-1.7.3  (dev-libs/libgcrypt) amd64 
   `--  dev-libs/libnl-3.2.27  (dev-libs/libnl) amd64 
   `--  dev-libs/libxml2-2.9.4  (>=dev-libs/libxml2-2.7.6) amd64 
   `--  net-analyzer/netcat6-1.0-r2  (>=net-analyzer/netcat6-1.0-r2) amd64 
   `--  net-analyzer/openbsd-netcat-1.105-r1  (>=net-analyzer/openbsd-netcat-1.105-r1) [~amd64 keyword] 
   `--  net-libs/gnutls-3.3.24-r1  (>=net-libs/gnutls-1.0.25) amd64 
   `--  net-libs/libssh2-1.7.0  (net-libs/libssh2) amd64 
   `--  net-misc/curl-7.50.3  (>=net-misc/curl-7.18.0) amd64 
   `--  sys-apps/dmidecode-2.12-r1  (sys-apps/dmidecode) amd64 
   `--  sys-apps/util-linux-2.26.2  (>=sys-apps/util-linux-2.17) amd64 
   `--  sys-devel/gettext-0.19.7  (sys-devel/gettext) amd64 
   `--  sys-libs/ncurses-5.9-r5  (sys-libs/ncurses) amd64 
   `--  sys-libs/readline-6.3_p8-r2  (sys-libs/readline) amd64 
   `--  sys-libs/libapparmor-2.10.1-r1  (sys-libs/libapparmor) [~amd64 keyword] 
   `--  sys-process/audit-2.4.3-r1  (sys-process/audit) amd64 
   `--  sys-libs/libcap-ng-0.7.7  (sys-libs/libcap-ng) amd64 
   `--  sys-libs/glibc-2.22-r4  (sys-libs/glibc) amd64  [rpc(+)]
   `--  net-firewall/firewalld-0.4.3.3  (net-firewall/firewalld) amd64 
   `--  sys-fs/fuse-2.9.7  (>=sys-fs/fuse-2.8.6) amd64 
   `--  sys-cluster/glusterfs-3.7.4  (>=sys-cluster/glusterfs-3.4.1) [~amd64 keyword] 
   `--  sys-block/open-iscsi-2.0.873  (sys-block/open-iscsi) amd64 
   `--  sys-fs/lvm2-2.02.116-r4  (>=sys-fs/lvm2-2.02.48-r2) amd64  [-device-mapper-only(-)]
   `--  net-fs/nfs-utils-1.3.1-r5  (net-fs/nfs-utils) amd64 
   `--  sys-process/numactl-2.0.11  (>sys-process/numactl-2.0.2) amd64 
   `--  sys-process/numad-0.5-r1  (sys-process/numad) amd64 
   `--  sys-kernel/openvz-sources-2.6.32.111.12  (sys-kernel/openvz-sources) amd64 
   `--  sys-block/parted-3.2  (>=sys-block/parted-1.8) amd64  [device-mapper]
   `--  net-libs/libpcap-1.8.0  (>=net-libs/libpcap-1.0.0) amd64 
   `--  sys-auth/polkit-0.113  (>=sys-auth/polkit-0.9) amd64 
   `--  app-emulation/qemu-2.7.0-r5  (>=app-emulation/qemu-0.13.0) amd64 
   `--  dev-libs/yajl-2.0.4-r3  (dev-libs/yajl) amd64 
   `--  sys-cluster/ceph-9.2.1-r2  (sys-cluster/ceph) amd64 
   `--  dev-libs/cyrus-sasl-2.1.26-r9  (dev-libs/cyrus-sasl) amd64 
   `--  sys-libs/libselinux-2.5-r1  (>=sys-libs/libselinux-2.0.85) amd64 
   `--  net-dns/dnsmasq-2.76  (net-dns/dnsmasq) amd64  [script]
   `--  net-firewall/ebtables-2.0.10.4  (net-firewall/ebtables) amd64 
   `--  net-firewall/iptables-1.4.21-r1  (>=net-firewall/iptables-1.4.10) amd64  [ipv6]
   `--  net-misc/radvd-2.14  (net-misc/radvd) amd64 
   `--  sys-apps/iproute2-4.4.0  (sys-apps/iproute2) amd64  [-minimal]
   `--  app-emulation/virtualbox-4.3.38  (app-emulation/virtualbox) amd64 
   `--  app-emulation/virtualbox-bin-5.1.8.111374  (>=app-emulation/virtualbox-bin-2.2.0) [~amd64 keyword] 
   `--  net-analyzer/wireshark-2.2.1  (net-analyzer/wireshark) amd64 
   `--  app-emulation/xen-4.6.3-r2  (app-emulation/xen) amd64 
   `--  app-emulation/xen-tools-4.6.3-r1  (app-emulation/xen-tools) amd64 
   `--  virtual/udev-215  (virtual/udev) amd64 
   `--  x11-libs/libpciaccess-0.13.4  (>=x11-libs/libpciaccess-0.10.9) amd64 
   `--  net-dns/avahi-0.6.32  (>=net-dns/avahi-0.6) amd64  [dbus]
   `--  app-text/xhtml1-20020801-r4  (app-text/xhtml1) amd64 
   `--  dev-lang/perl-5.22.2  (dev-lang/perl) amd64 
   `--  dev-libs/libxslt-1.1.29  (dev-libs/libxslt) amd64 
   `--  dev-perl/XML-XPath-1.130.0-r1  (dev-perl/XML-XPath) amd64 
   `--  virtual/pkgconfig-0-r1  (virtual/pkgconfig) amd64 
[ app-emulation/libvirt-2.3.0 stats: packages (54), max depth (1) ]

```
